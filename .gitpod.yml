# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/introduction/learn-gitpod/gitpod-yaml)
# and commit this file to your remote git repository to share the goodness with others.

# Learn more from ready-to-use templates: https://www.gitpod.io/docs/introduction/getting-started/quickstart

tasks:
  - init: |
      # Update and install necessary tools
      sudo apt-get update > /workspace/init.log 2>&1
      sudo apt-get install -y apt-transport-https ca-certificates curl > /workspace/init.log 2>&1

      # Install k3s (Lightweight Kubernetes) along with kubectl
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable=traefik" sh - >> /workspace/init.log 2>&1

      # Install Python virtual environment
      python3 -m venv venv

      # Install Python dependencies within the virtual environment
      source venv/bin/activate
      pip install -r requirements.txt >> /workspace/init.log 2>&1

  - command: |
      # Wait for k3s to start up before running kubectl commands
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      until kubectl get nodes; do sleep 2; done

      # Apply the Kubernetes deployment file (adjust the path if needed)
      kubectl apply -f deployment.yaml || echo "K3s or Kubernetes deployment failed."

  - command: |
      # Activate the virtual environment and start the Flask development server
      source venv/bin/activate && python app.py









